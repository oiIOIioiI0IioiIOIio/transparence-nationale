name: ðŸ—³ï¸ Mise Ã  jour des donnÃ©es Ã©lus

on:
  # ExÃ©cution manuelle
  workflow_dispatch:
    inputs:
      limit:
        description: "Nombre d'Ã©lus Ã  traiter (laisser vide pour tous)"
        required: false
        default: ""
      force:
        description: "Forcer le re-tÃ©lÃ©chargement des XMLs"
        required: false
        type: boolean
        default: false
      skip_existing:
        description: "Passer les Ã©lus dÃ©jÃ  traitÃ©s"
        required: false
        type: boolean
        default: true
  
  # ExÃ©cution programmÃ©e (tous les dimanches Ã  2h du matin)
  schedule:
    - cron: '0 2 * * 0'

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install -r scripts/requirements.txt
      
      - name: Restore HATVP cache
        uses: actions/cache@v4
        with:
          path: |
            public/data/hatvp_cache
          key: hatvp-cache-${{ github.run_id }}
          restore-keys: |
            hatvp-cache-
      
      - name: GÃ©nÃ©rer les donnÃ©es Ã©lus
        id: generate
        run: |
          # Construction de la commande
          CMD="python scripts/generate-elus.py --delay 0.5"
          
          # Ajout de la limite si prÃ©sente
          if [ -n "$\{ inputs.limit }" ]; then
            CMD="$CMD --limit $\{ inputs.limit }"
          fi
          
          # Ajout du flag force si cochÃ©
          if [ "$\{ inputs.force }" == "true" ]; then
            CMD="$CMD --force"
          fi
          
          # Ajout du flag skip-existing (activÃ© par dÃ©faut en schedule, configurable en manuel)
          if [ "$\{ inputs.skip_existing }" != "false" ]; then
            CMD="$CMD --skip-existing"
          fi
          
          echo "ExÃ©cution : $CMD"
          eval $CMD
      
      - name: VÃ©rifier les changements
        id: check_changes
        run: |
          if git diff --quiet public/data/elus.json; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            COUNT=$(python3 -c "import json; d=json.load(open('public/data/elus.json')); print(len(d))" 2>/dev/null || echo "0")
            echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          DATE=$(date -u +"%Y-%m-%d")
          COUNT=${{ steps.check_changes.outputs.count }}
          git add public/data/elus.json
          git add public/data/hatvp_cache/
          git commit -m "ðŸ¤– Update HATVP data - ${DATE} (${COUNT} Ã©lus)"
          git push
      
      - name: Deploy to Vercel (production)
        if: github.ref == 'refs/heads/main' && steps.check_changes.outputs.changed == 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
      
      - name: Summary
        if: always()
        run: |
          if [ "$\{ steps.check_changes.outputs.changed }" == "true" ]; then
            echo "## âœ… DonnÃ©es mises Ã  jour" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Ã‰lus gÃ©nÃ©rÃ©s** : ${{ steps.check_changes.outputs.count }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Date** : $(date -u +"%Y-%m-%d %H:%M UTC")" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## â„¹ï¸ Aucun changement dÃ©tectÃ©" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Les donnÃ©es sont dÃ©jÃ  Ã  jour." >> "$GITHUB_STEP_SUMMARY"
          fi
